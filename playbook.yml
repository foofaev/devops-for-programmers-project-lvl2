---
- name: Prepare host machine
  gather_facts: 'no'
  hosts: all
  tasks:
    - name: Run apt update cache and apt upgrade
      apt:
        upgrade: 'yes'
        update_cache: true
        cache_valid_time: 3600

    - name: Install pip
      include_role:
        name: geerlingguy.pip

    - name: Create .env file with secrets
      ansible.builtin.template:
        src: ./templates/environment.j2
        dest: /root/.env

- name: Deploy app
  gather_facts: 'no'
  hosts: all
  become: true
  tasks:
    - name: Create and start redmine
      community.docker.docker_container:
        container_default_behavior: no_defaults
        name: app
        image: redmine:4.2.1
        state: started
        restart: true
        published_ports:
          - '80:3000'
        env_file: /root/.env

- name: Setup monitoring
  hosts: webservers
  tasks:
    - name: Install and run datadog agent
      include_role:
        name: datadog.datadog
